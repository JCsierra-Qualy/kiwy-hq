# Progress Log
Run: 4853a77d-9e72-442e-a85d-ca7159673fec
Task: Kiwy HQ MVP v1
Started: 2026-02-15T17:07:00Z

## Codebase Patterns
- Express app factory is `createApp()` in `src/server.ts`; tests import it and spin up an ephemeral port via `app.listen(0)`.
- Tests use `node:test` with the built-in `http` client (no supertest) and run via `node --import tsx --test`.
- Route protection is implemented via an `app.use()` middleware that redirects to `/login` when `kiwy_hq_auth` cookie is missing.
- HTML pages are server-rendered via a shared `pageLayout()` helper in `src/ui/layout.ts` (re-exported from `src/ui`) which sets `data-kiwy-shell="v1"` for easy test assertions.
- Secrets are stored in a local JSON file via `src/secrets-store.ts`; tests can override the storage path with `KIWY_HQ_SECRETS_PATH`.

---

## 2026-02-15 - US-001: Auth: token login page + httpOnly cookie session
- Added `/login` (GET HTML form + POST token validation against `KIWY_HQ_TOKEN`) and `/logout` (POST clears cookie).
- Cookie session is stored in an httpOnly cookie (`kiwy_hq_auth`) with `SameSite=Lax`.
- Added auth flow tests for login/logout.
- Files changed: `src/server.ts`, `test/auth.test.ts`
- **Learnings:** Keep request parsing enabled via `express.urlencoded()` for simple HTML form posts.
---

## 2026-02-15 - US-002: Auth: protect routes with middleware
- Added `authRequiredMiddleware` to protect all routes except `/health` and `/login`; unauthenticated users are redirected to `/login`.
- Added placeholder `/secrets` route (protected by middleware).
- Updated logout test to include auth cookie.
- Files changed: `src/server.ts`, `test/auth.test.ts`
- **Learnings:** When using express + cookie-parser, `req.path` is a simple way to match public routes inside global auth middleware.
---

## 2026-02-15T17:32:54Z - US-003: UI shell: Kiwy-themed layout + navigation
- Added a Kiwy-themed HTML shell (header + nav + footer) shared across authenticated pages.
- Updated `/` dashboard page content into simple grouped cards (Qualiver/ECHO/Kuenti/Personal).
- Updated `/secrets` page to use the same shell and show UI-only placeholders without rendering any secret values.
- Added HTML rendering tests to confirm shared layout, nav links, and that secrets are not printed.
- Files changed: `src/server.ts`, `test/ui-shell.test.ts`
- **Learnings:** Add a stable marker attribute (`data-kiwy-shell`) to make HTML rendering tests resilient to copy changes.
---

## 2026-02-15T17:43:43Z - US-004: Secrets: local file store with chmod 600 + masked display
- Implemented secrets local file store at `data/secrets.json` (gitignored) with best-effort `chmod 600` and atomic write.
- Updated `/secrets` UI to show masked previews only (`first4...last4`) and added POST handler to write/update secrets.
- Added tests covering POST persistence, file permissions, and that HTML never renders full secret values.
- Files changed: `src/server.ts`, `src/secrets-store.ts`, `test/secrets-store.test.ts`
- **Learnings:** Use `KIWY_HQ_SECRETS_PATH` to redirect secrets storage in tests.
---

## 2026-02-15T17:56:28Z - US-001: Modularize SSR HTML templates (shell/layout/components) without changing behavior
- Extracted `escapeHtml()` and `pageLayout()` into `src/ui/layout.ts` and re-exported via `src/ui/index.ts`.
- Updated `src/server.ts` to import UI helpers (no duplicated shell/layout logic in routes).
- Added unit tests for template helpers to ensure HTML shell markers and escaping behavior are stable.
- Files changed: `src/server.ts`, `src/ui/layout.ts`, `src/ui/index.ts`, `test/ui-layout.test.ts`
- **Learnings:** Keep shell HTML output byte-for-byte identical when moving templates to avoid churn in integration tests; unit tests can validate stable markers and active nav rendering.
---
